<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
      PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns = "http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

<head>
 <title>Drag And Drop</title>

<style>
</style>
 <script><![CDATA[ 
  var SVGDocument = null;
  var SVGRoot = null; 

  var TrueCoords = null;

  var DragTarget = null;
  var Left;
  var Right;
  var TLeft;
  var TRight;
  var Centre;
  var OldBound;
  var NowBound;
  var BackDrop;
  var FirstQuart;
  var FirstLabel;  
  var ThirdQuart;
  var ThirdLabel;
  var Line;
  var AdjustButton;
  var DoneButton;
  
  var lowBound;
  var highBound;
  var pixDistance;
  var scale;
  var ratio;
  var time;
  var q1;
  var q3;
  var midPoint;
  
  var leftVal = 440;	// pixel location
  var rightVal = 830;

  var leftie = 330;	// original "time"
  var rightie = 840;

  var alreadyThereL = false;
  var alreadyThereR = false;

  var LEFT_X = 50;	// pixels
  var RIGHT_X = 1200;

  function Init(evt){
   SVGDocument = evt.target.ownerDocument;
   SVGRoot = SVGDocument.documentElement;
   StartTimeLine(-1500, 2010, 50, 1220);  // user input
  };

  function StartTimeLine(low, high, l, r){

   if(low <= high){
    lowBound = low;
    highBound = high;
   }
   else{
    lowBound = high;
    highBound = low;
   }
   if(l <= r){
    LEFT_X = l;
    RIGHT_X = r;
   }
   else{
    LEFT_X = r;
    RIGHT_X = l;
   }

   TrueCoords = SVGRoot.createSVGPoint();
   Left = SVGDocument.getElementById('LeftSlider');
   Right = SVGDocument.getElementById('RightSlider');
   TLeft = SVGDocument.getElementById('ChangeL');
   TRight = SVGDocument.getElementById('ChangeR');
   Centre = SVGDocument.getElementById('TextBox');
   CentreLine = SVGDocument.getElementById('MiddlePath');
   OldBound = SVGDocument.getElementById('LeftBound');
   NowBound = SVGDocument.getElementById('RightBound');
   FirstQuart = SVGDocument.getElementById('Quarter1');
   ThirdQuart = SVGDocument.getElementById('Quarter3');
   BackDrop = SVGDocument.getElementById('BackDrop');
   RPath = SVGDocument.getElementById('RPath');
   LPath = SVGDocument.getElementById('LPath');
   Line = SVGDocument.getElementById('TimeLine');
   AdjustButton = SVGDocument.getElementById('Adjust');
   DoneButton = SVGDocument.getElementById('Done');

   LPath.setAttributeNS(null, 'x1', LEFT_X);
   LPath.setAttributeNS(null, 'x2', LEFT_X);
   OldBound.setAttributeNS(null, 'x', LEFT_X);

   RPath.setAttributeNS(null, 'x1', RIGHT_X);
   RPath.setAttributeNS(null, 'x2', RIGHT_X);
   NowBound.setAttributeNS(null, 'x', RIGHT_X);

   Line.setAttributeNS(null, 'x1', LEFT_X);
   Line.setAttributeNS(null, 'x2', RIGHT_X);

   q1 = Math.round(((RIGHT_X - LEFT_X) / 4) + LEFT_X);	// pixels
   q3 = Math.round(RIGHT_X - ((RIGHT_X - LEFT_X) / 4));	// pixels

   FirstQuart.setAttributeNS(null, 'x1', q1);
   FirstQuart.setAttributeNS(null, 'x2', q1);

   ThirdQuart.setAttributeNS(null, 'x1', q3);
   ThirdQuart.setAttributeNS(null, 'x2', q3);

   mid = Math.round(((RIGHT_X - LEFT_X) / 2) + LEFT_X);	// pixels
   
   CentreLine.setAttributeNS(null, 'x1', mid);
   CentreLine.setAttributeNS(null, 'x2', mid);
   Centre.setAttributeNS(null, 'x', mid);

   third = (RIGHT_X - LEFT_X) / 3; // pixels
   leftVal = third + LEFT_X;
   rightVal = RIGHT_X - third;

   Left.setAttributeNS(null, 'cx', leftVal);
   TLeft.setAttributeNS(null, 'x', leftVal);
   Right.setAttributeNS(null, 'cx', rightVal);
   TRight.setAttributeNS(null, 'x', rightVal);

   SetBounds();
   FindPoints();
  };

  function SetBounds(){
   ChangeThing(lowBound, OldBound);
   ChangeThing(highBound, NowBound);
  };

  function FindPoints(){
   length = highBound - lowBound;
   temp = length / 3;
   leftie = Math.round(lowBound + temp);
   rightie = Math.round(highBound - temp);

   mid = length / 2;				// value
   midPoint = Math.round(highBound - mid);
   if(midPoint == 0){
    midPoint = 1;
   }
   
   ChangeThing(midPoint, Centre);
   ChangeThing(leftie, TLeft);
   ChangeThing(rightie, TRight);
  };

  function ChangeThing(xVal, thing){
   if(xVal < 0){
    xVal = xVal * -1;
    newText = SVGDocument.createTextNode(xVal + ' BCE');
   }
   else{
    newText = SVGDocument.createTextNode(xVal + ' CE');
   }
   thing.replaceChild(newText, thing.firstChild);
  };

  function Grab(evt){
   var targetElement = evt.target;
   if(targetElement == Left || targetElement == Right){
    DragTarget = targetElement;
    DragTarget.parentNode.appendChild(DragTarget); // if this is gone, behaviour is different on the 2nd drag
    DragTarget.setAttributeNS(null, 'pointer-events', 'none');
   }
  };

  function Drag(evt){
   if(DragTarget){
    newX = CheckBounds(evt.clientX);
    if(DragTarget == Left){
     if(newX <= (rightVal - 10)){
      DragTarget.setAttributeNS(null, 'cx', newX);
      TLeft.setAttributeNS(null, 'x', newX);
      if(newX >= (rightVal - 60) && (alreadyThereR == false)){
       TLeft.setAttributeNS(null, 'y', 160);
       alreadyThereL = true;
      }
      else{
       TLeft.setAttributeNS(null, 'y', 145);
       alreadyThereL = false;
      }
      ChangeWords(evt.clientX, TLeft);
      leftVal = newX;
     }
    }
    else if(DragTarget == Right){
     if(newX >= (leftVal + 10)){
      DragTarget.setAttributeNS(null, 'cx', newX);
      TRight.setAttributeNS(null, 'x', newX);
      if(newX <= (leftVal + 60) && (alreadyThereL == false)){
       TRight.setAttributeNS(null, 'y', 160);
       alreadyThereR = true;
      }
      else{
       TRight.setAttributeNS(null, 'y', 145);
       alreadyThereR = false;
      }
      ChangeWords(evt.clientX, TRight);
      rightVal = newX;
     }
    }
    AdjustButton.setAttributeNS(null, 'fill-opacity', 0.0);
    DoneButton.setAttributeNS(null, 'fill-opacity', 0.0);
   }
  };

  function Drop(evt){
   if(DragTarget){
    var targetElement = evt.target;
    DragTarget.setAttributeNS(null, 'pointer-events', 'all');
    DragTarget = null;
    DoQuery(leftie, rightie);
   }
  };

  function ChangeWords(xVal, slider){
   newVal = Scale(xVal);
   if(newVal < lowBound){	
    newVal = lowBound;
   }
   else if(newVal > highBound){
    newVal = highBound;
   }
   ChangeThing(newVal, slider);
   if(slider == TRight){
    rightie = newVal;
   }
   else if(slider == TLeft){
    leftie = newVal;
   }
  };

  function Scale(x){
   scale = highBound - lowBound;
   pixDistance = RIGHT_X - LEFT_X;
   ratio = (x - LEFT_X) / pixDistance;
   time = Math.round(ratio * scale) + lowBound;
   return time;
  };

  function CheckBounds(x){
   if(x <= LEFT_X){
    return LEFT_X;
   }
   else if(x >= RIGHT_X){
    return RIGHT_X;
   }
   return x;
  };

  function Adjust(evt){
   var targetElem = evt.target;
   if(targetElem == AdjustButton){
    StartTimeLine(leftie, rightie, LEFT_X, RIGHT_X);
    AdjustButton.setAttributeNS(null, 'fill-opacity', 1.0);
   }
  };

  function DoQuery(left, right){
   alert(left);
   alert(right);
  };

 ]]></script>
</head>

<body>
<svg width="1260" height="1000" xmlns="http://www.w3.org/2000/svg" onload="Init(evt)" onmousedown="Grab(evt)" onmousemove="Drag(evt)" onmouseup="Drop(evt)" onclick = "Adjust(evt)">

 <rect id = "BackDrop" x = "-10%" y = "-10%" width = "110%" height = "110%" fill = "none" pointer-events = "all"></rect>
 
 <g id = "RBound" style = "font-family: sans-serif; font-weight: bold; font-size: 12pt">
  <text id = "RightBound" x = "1200" y = "60" text-anchor = "middle">Top Bound</text>
  <line id = "RPath" stroke-width = "5" stroke = "black" x1 = "1200" y1 = "63" x2 = "1200" y2 = "117"></line>
 </g>

 <g id = "LBound" style = "font-family: sans-serif; font-weight: bold; font-size: 12pt">
  <text id = "LeftBound" x = "50" y = "60" text-anchor = "middle">Low Bound</text>
  <line id = "LPath" stroke-width = "5" stroke = "black" x1 = "50" y1 = "63" x2 = "50" y2 = "117"></line>
 </g>

 <g id = "1Year" style = "font-family: sans-serif; font-weight: bold; font-size: 12pt">
  <text id = "TextBox" x = "635" y = "60" text-anchor = "middle">Centre</text>
  <line id = "MiddlePath" stroke-width = "5" stroke = "black" x1 = "635" y1 = "70" x2 = "635" y2 = "110"></line>
 </g>

 <g id = "AB" style = "font-family: sans-serif; font-weight: bold; font-size: 12pt; text-anchor: middle">
  <text id = "AText" x = "635" y = "190">Adjust</text>
  <rect id = "Adjust" x = "594" y = "175" width = "80" height = "40" fill = "green" stroke = "black" stroke-width = "2" fill-opacity = "1.0"></rect>
 </g>

 <g id = "TL" style = "font-family: sans-serif; font-weight: bold; font-size: 10pt; text-anchor: middle">
  <line id = "TimeLine" stroke-width = "2" stroke = "black" x1 = "50" y1 = "90" x2 = "1200" y2 = "90"></line>
  <line id = "Quarter1" stroke-width = "2" stroke = "black" x1 = "343" y1 = "75" x2 = "343" y2 = "105"></line>
  <line id = "Quarter3" stroke-width = "2" stroke = "black" x1 = "928" y1 = "75" x2 = "928" y2 = "105"></line>
 </g>

 <g id = "Left">
  <text id = "ChangeL" x = "440" y = "145" font-family = "sans-serif" font-weight = "bold" font-size = "12pt" text-anchor = "middle">Left</text>
  <circle id = "LeftSlider" cx="440" cy="90" r="5" style="fill: blue;" stroke="black" stroke-width="2"></circle>
 </g>

 <g id = "Right">
  <text id = "ChangeR" x = "830" y = "145" font-family = "sans-serif" font-weight = "bold" font-size = "12pt" text-anchor = "middle">Right</text>
  <circle id="RightSlider" cx="830" cy="90" r="5" style="fill: red;" stroke="black" stroke-width="2"></circle>
 </g>

</svg>
</body>
</html>